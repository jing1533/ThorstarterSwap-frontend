var w=Object.defineProperty;var E=(n,e)=>w(n,"name",{value:e,configurable:!0});import{providers as C}from"ethers";import{getMessageFromCode as N}from"eth-rpc-errors";import{RPCErrorCode as u,SignerError as c,SignerErrorCode as d}from"rango-types";var R={rpc:{invalidInput:-32e3,resourceNotFound:-32001,resourceUnavailable:-32002,transactionRejected:-32003,methodNotSupported:-32004,limitExceeded:-32005,parse:-32700,invalidRequest:-32600,methodNotFound:-32601,invalidParams:-32602,internal:-32603},provider:{userRejectedRequest:4001,unauthorized:4100,unsupportedMethod:4200,disconnected:4900,chainDisconnected:4901}};var g=E(n=>{if(!n)return new c(d.SEND_TX_ERROR);if(c.isSignerError(n))return n;let e=Object.prototype.hasOwnProperty.call(n,"message"),i=Object.prototype.hasOwnProperty.call(n,"code");if(e&&i){let{message:r,code:t}=n;if("ACTION_REJECTED"===t||R.provider.userRejectedRequest===t)return new c(d.REJECTED_BY_USER,void 0,n,u.REJECTION,n);if(typeof t=="number"){if(Object.values(R.provider).includes(t)){let s=N(t);return new c(d.SEND_TX_ERROR,void 0,s,u.UNKNOWN_ERROR,n)}else if(Object.values(R.rpc).includes(t)){if(t===R.rpc.internal&&(r?.includes("underpriced")||r?.includes("replacement fee too low")))return new c(d.SEND_TX_ERROR,void 0,"Transaction is underpriced.",u.UNDER_PRICED,n);if(r?.includes("intrinsic gas too low")||r?.includes("out of gas"))return new c(d.SEND_TX_ERROR,void 0,"Gas limit is low.",u.OUT_OF_GAS,n);let s=N(t);return new c(d.SEND_TX_ERROR,void 0,s??n,u.UNKNOWN_ERROR,n)}}switch(t){case"INVALID_ARGUMENT":{let s=(n.reason||n.message)??n;return new c(d.SEND_TX_ERROR,void 0,s,u.UNKNOWN_ERROR,n)}}}return new c(d.SEND_TX_ERROR,void 0,n,u.UNKNOWN_ERROR,n)},"cleanEvmError");async function _(n,e){if(!n||!e)return;let i=parseInt(n);try{let r=`https://api.tenderly.co/api/v1/public-contract/${i}/tx/${e}`,t=await fetch(r,{method:"GET"});return t.ok?(await t.json())?.error_message:void 0}catch{return}}E(_,"getTenderlyError");var l=E(async n=>new Promise(e=>setTimeout(e,n)),"waitMs");import{RPCErrorCode as I,SignerError as f,SignerErrorCode as h}from"rango-types";var y=E(async(n,e,i,r)=>{let t=!1;return await Promise.race([(async()=>{await e.wait(r),t=!0})(),(async()=>{for(;!t;){if(await l(3e3),t)return null;try{if(!await n.getTransaction(i))return null}catch(s){return console.log({error:s}),null}}return null})()])},"waitWithMempoolCheck"),p=class{constructor(e){this.provider=new C.Web3Provider(e),this.signer=this.provider.getSigner()}async signMessage(e){try{return await this.signer.signMessage(e)}catch(i){throw new f(h.SIGN_TX_ERROR,void 0,i)}}async signAndSendTx(e,i,r){try{this.signer=this.provider.getSigner(e.from??void 0);let t=p.buildTx(e),s=await this.signer.getChainId(),o=await this.signer.getAddress();if(r&&s&&s!==parseInt(r))throw new f(h.UNEXPECTED_BEHAVIOUR,void 0,`Signer chainId: '${s}' doesn't match with required chainId: '${r}' for tx.`);if(o&&i&&o.toLowerCase()!==i.toLowerCase())throw new f(h.UNEXPECTED_BEHAVIOUR,void 0,`Signer address: '${o.toLowerCase()}' doesn't match with required address: '${i.toLowerCase()}' for tx.`);try{let a=await this.signer.sendTransaction(t);return{hash:a.hash,response:a}}catch(a){if(a?.message&&typeof a.message=="string"&&a.message.indexOf("EIP-1559")!==-1){console.log("retrying EIP-1559 error without v2 fields ...");let T=p.buildTx(e,!0),m=await this.signer.sendTransaction(T);return{hash:m.hash,response:m}}else throw a}}catch(t){throw g(t)}}async wait(e,i,r,t){try{if(r)return await r?.wait(t),{hash:e};if(!this.provider)return{hash:e};if(this.signer=this.provider.getSigner(),!i)return{hash:e};let s=await this.signer.getChainId();if(!s||parseInt(i)!=s)return{hash:e};let o=await this.provider.getTransaction(e);if(!o)throw Error(`Transaction hash '${e}' not found in blockchain.`);return await y(this.provider,o,e,t),{hash:e}}catch(s){let o=s;if(o?.code==="TRANSACTION_REPLACED"&&o?.replacement)return{hash:o?.replacement?.hash,response:o?.replacement};if(o?.code==="CALL_EXCEPTION"){let a=await _(i,e);if(a)throw new f(h.TX_FAILED_IN_BLOCKCHAIN,"Trannsaction failed in blockchain",a,I.CALL_EXCEPTION,o);return{hash:e}}throw g(o)}}static buildTx(e,i=!1){let r={};return e.from&&(r={...r,from:e.from}),e.to&&(r={...r,to:e.to}),e.data&&(r={...r,data:e.data}),e.value&&(r={...r,value:e.value}),e.nonce&&(r={...r,nonce:e.nonce}),e.gasLimit&&(r={...r,gasLimit:e.gasLimit}),e.gasPrice&&(r={...r,gasPrice:"0x"+parseInt(e.gasPrice).toString(16)}),e.maxFeePerGas&&!i&&(r={...r,maxFeePerGas:e.maxFeePerGas}),e.maxPriorityFeePerGas&&!i&&(r={...r,maxPriorityFeePerGas:e.maxPriorityFeePerGas}),r}};E(p,"DefaultEvmSigner");export{p as DefaultEvmSigner,g as cleanEvmError,l as waitMs};
//# sourceMappingURL=index.js.map
